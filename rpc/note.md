# 微服务

> 客户端做，需要实现一套注册中心，记录服务地址，知道具体访问那个，轮训算法去做，加权轮询
>
>服务端做： 比较简单，服务端启动，自动注册即可，aws 的ELB去访问
>
微服务一般不用LVS负责，扩展实例需要改配置，不符合微服务弹性扩展思想
etcd 解决分布式一致性 ，raft
etcd 使用场景：
    1. 注册发现
    2. 共享配置
    3. 分布式锁
    4. leader选举
    
1. rpc 相关内容
    1. 数据传输：JSON Protobuf thrift
    2. 负载：随机算法 轮询 一致性hash 加权
    3. 异常容错：健康检测 熔断 限流
1. 服务监控
    2. 日志收集
    3. 打点采样
    
## 要求
1. golang写RPC程序，必须符合4个基本条件，不然RPC用不了

2. 结构体字段首字母要大写，可以别人调用

3. 函数名必须首字母大写

4. 函数第一参数是接收参数，第二个参数是返回给客户端的参数，必须是指针类型

5. 函数还必须有一个返回值error

## rpc调用流程
1. 微服务架构下数据交互一般是对内 RPC，对外 REST
2. 将业务按功能模块拆分到各个微服务，具有提高项目协作效率、降低模块耦合度、提高系统可用性等优点，但是开发门槛比较高，比如 RPC 框架的使用、后期的服务监控等工作
3. 一般情况下，我们会将功能代码在本地直接调用，微服务架构下，我们需要将这个函数作为单独的服务运行，客户端通过网络调用

## 网络传输数据格式
两端要约定好数据包的格式
成熟的RPC框架会有自定义传输协议，这里网络传输格式定义如下，前面是固定长度消息头，后面是变长消息体



## 服务治理（失败模式与负载均衡）
rpcx 支持故障模式：
    1. Failfast：如果调用失败，立即返回错误
    2. Failover：选择其他节点，直到达到最大重试次数
    3. Failtry：选择相同节点并重试，直到达到最大重试次数
负载均衡
1. Random： 随机选择节点
>   Roundrobin： 使用 roundrobin 算法选择节点
>   Consistent hashing: 如果服务路径、方法和参数一致，就选择同一个节点。使用了非常快的jump consistent hash算法。
>   Weighted: 根据元数据里配置好的权重(weight=xxx)来选择节点。类似于nginx里的实现(smooth weighted algorithm)
>  Network quality: 根据ping的结果来选择节点。网络质量越好，该节点被选择的几率越大。
>   Geography: 如果有多个数据中心，客户端趋向于连接同一个数据机房的节点。
>   Customized Selector: 如果以上的选择器都不适合你，你可以自己定制选择器。例如一个rpcx用户写过它自己的选择器，他有2个数据中心，但是这些数据中心彼此有限制，不能使用 Network quality 来检测连接质量。


## 广播 与群发
Xclient 的 Broadcast ， 和Fork方法
> Broadcast 表示向所有服务器发送请求，只有全部正确返回才会成功，这里设置超时来避免阻塞
> Fork 向所有服务器发送请求，只要任意一台服务器返回就成功。


